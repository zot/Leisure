// Generated by CoffeeScript 1.10.0
(function() {
  'use strict';
  var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  define(['./base', './org', './docOrg', './ast', './eval', './editor', 'lodash', 'jquery', './ui', 'handlebars', './lib/prism', './editorSupport', 'bluebird', './advice', './lib/prism-leisure', 'lib/js-yaml'], function(Base, Org, DocOrg, Ast, Eval, Editor, _, $, UI, Handlebars, Prism, EditorSupport, Bluebird, Advice, PrismLeisure, Yaml) {
    var DataStore, DataStoreEditingOptions, Drawer, Example, Fragment, HL_LEVEL, HL_PRIORITY, HL_TAGS, HL_TEXT, HL_TODO, HTML, Headline, Html, KEYWORD_, KW_BOILERPLATE, KW_INFO, Keyword, LeisureEditCore, Link, ListItem, Meat, Nil, OrgEditing, Promise, SimpleMarkup, _workSpan, addController, addPendingTooltip, addView, afterMethod, beforeMethod, blockCodeItems, blockEnvMaker, blockIsHidden, blockOrg, blockSource, blockText, blockVars, changeAdvice, classifyListItems, cleanOrg, closeList, controllerEval, copy, copyBlock, createValueSliders, createWorkSpan, currentSlider, defaultEnv, doSlideValue, escapeAttr, escapeHtml, fancyEditDiv, fancyHtml, fancyMode, fancyReplacements, findEditor, findFirstLetter, getCodeItems, getEventChar, getSliderPosition, goodHtml, goodText, hasView, headlineRE, html, initializePendingViews, insertBreaks, isFirstText, isHiddenSlide, isMeat, isSidebar, isViewResult, isYamlResult, keywordRE, languageEnvMaker, last, mayHideValueSlider, maybeFirst, maybeReplaceHtml, mergeContext, mergeMeat, namedNode, nextImageSrc, nextViewId, numPat, optWrench, orgDoc, parseMeat, parseOrgMode, parseYaml, pendingTooltips, plainEditDiv, plainMode, posFor, prefixBreak, preserveSelection, prevImageSrc, prismAliases, prismHighlight, pushPendingInitialzation, removeController, removeView, renderView, replacementTargets, resultsArea, sendSliderChange, setSliderValue, setSliding, showValueSlider, showsCode, showsResults, singleControllers, slideNode, slideValue, toggleSlideMode, touchedBlocks, unescapeString, updateSelection, viewKey, withContext, workSpan;
    defaultEnv = Base.defaultEnv;
    changeAdvice = Advice.changeAdvice, afterMethod = Advice.afterMethod, beforeMethod = Advice.beforeMethod;
    parseOrgMode = Org.parseOrgMode, parseMeat = Org.parseMeat, Fragment = Org.Fragment, Headline = Org.Headline, SimpleMarkup = Org.SimpleMarkup, Link = Org.Link, Keyword = Org.Keyword, ListItem = Org.ListItem, Drawer = Org.Drawer, Meat = Org.Meat, Example = Org.Example, HTML = Org.HTML, Nil = Org.Nil, headlineRE = Org.headlineRE, HL_LEVEL = Org.HL_LEVEL, HL_TODO = Org.HL_TODO, HL_PRIORITY = Org.HL_PRIORITY, HL_TEXT = Org.HL_TEXT, HL_TAGS = Org.HL_TAGS, keywordRE = Org.keywordRE, KW_BOILERPLATE = Org.KW_BOILERPLATE, KW_INFO = Org.KW_INFO, KEYWORD_ = Org.KEYWORD_;
    orgDoc = DocOrg.orgDoc, getCodeItems = DocOrg.getCodeItems, blockSource = DocOrg.blockSource, parseYaml = DocOrg.parseYaml;
    Nil = Ast.Nil;
    languageEnvMaker = Eval.languageEnvMaker, Html = Eval.Html, escapeHtml = Eval.escapeHtml, html = Eval.html, blockVars = Eval.blockVars, isYamlResult = Eval.isYamlResult, unescapeString = Eval.unescapeString;
    LeisureEditCore = Editor.LeisureEditCore, last = Editor.last, DataStore = Editor.DataStore, DataStoreEditingOptions = Editor.DataStoreEditingOptions, blockText = Editor.blockText, posFor = Editor.posFor, escapeHtml = Editor.escapeHtml, copy = Editor.copy, findEditor = Editor.findEditor, copyBlock = Editor.copyBlock, preserveSelection = Editor.preserveSelection, getEventChar = Editor.getEventChar;
    addView = UI.addView, removeView = UI.removeView, renderView = UI.renderView, hasView = UI.hasView, viewKey = UI.viewKey, addController = UI.addController, removeController = UI.removeController, withContext = UI.withContext, mergeContext = UI.mergeContext, initializePendingViews = UI.initializePendingViews, escapeAttr = UI.escapeAttr, nextImageSrc = UI.nextImageSrc, prevImageSrc = UI.prevImageSrc, pushPendingInitialzation = UI.pushPendingInitialzation, nextViewId = UI.nextViewId, touchedBlocks = UI.touchedBlocks;
    OrgEditing = EditorSupport.OrgEditing, blockOrg = EditorSupport.blockOrg, blockCodeItems = EditorSupport.blockCodeItems, blockIsHidden = EditorSupport.blockIsHidden, blockEnvMaker = EditorSupport.blockEnvMaker, controllerEval = EditorSupport.controllerEval, updateSelection = EditorSupport.updateSelection;
    Promise = Bluebird.Promise;
    singleControllers = {};
    numPat = /-?[0-9][0-9.]*|-?\.[0-9.]+/;
    currentSlider = null;
    plainMode = {
      name: 'plain',
      keyPress: function(opts, parent, e) {
        return parent(e);
      },
      enter: function(opts, parent, e) {
        return parent(e);
      },
      handleDelete: function(opts, parent, e, sel, forward) {
        return parent(e);
      },
      renderBlocks: function(opt, html) {
        return html;
      },
      setSlideMode: function(opt, flag) {},
      showingSlides: function() {
        return false;
      },
      showNextSlide: function() {
        return false;
      },
      showPrevSlide: function() {
        return false;
      },
      handleChanges: function(changes) {},
      renderChanged: function(opts, blocks, prefix, replace) {
        var block, id, ref, results1;
        ref = opts.slidesFor(blocks);
        results1 = [];
        for (id in ref) {
          block = ref[id];
          results1.push(this.render(opts, block, prefix, replace));
        }
        return results1;
      },
      render: function(opts, block, prefix, replace) {
        var attrs, error, name, pos, ref, ref1, ref2, ref3, ref4, result, results, source, text;
        opts.trigger('render', opts.editor, block);
        ref = blockCodeItems(this, block), name = ref.name, source = ref.source, error = ref.error, results = ref.results;
        attrs = "id='" + prefix + block._id + "' data-block='" + block.type + "'";
        if (block.type === 'headline') {
          attrs += " data-headline='" + block.level + "'";
        }
        if (!results && !error) {
          text = this.renderMainBlock(block);
        } else {
          text = name ? this.renderMainText(block.text.substring(0, source != null ? source.offset : void 0)) : '';
          if (!error) {
            text += this.renderMainText(block.text.substring(source.offset, (ref1 = results != null ? results.offset : void 0) != null ? ref1 : block.text.length));
          } else {
            pos = source.offset + source.contentPos + Number(error.info.match(/([^,]*),/)[1]) - 1;
            text = escapeHtml(block.text.substring((ref2 = name != null ? name.offset : void 0) != null ? ref2 : 0, pos)) + "<span class='errorMark' contenteditable='false' data-noncontent>✖</span>" + escapeHtml(block.text.substring(pos, (ref3 = results != null ? results.offset : void 0) != null ? ref3 : block.text.length));
          }
          if (results != null) {
            text += "" + (escapeHtml((ref4 = results != null ? results.text : void 0) != null ? ref4 : '')) + (escapeHtml(block.text.substring(results.offset + results.text.length)));
          }
        }
        result = "<span " + attrs + ">" + text + "</span>";
        maybeReplaceHtml(block, prefix, result, replace);
        return [result, block.next];
      },
      renderMainBlock: function(block) {
        var text, txt;
        txt = block.text;
        if (block.type === 'headline') {
          text = parseOrgMode(block.text).children[0].partOffsets().text;
          return "<div class='plain-headline maintext'>" + (escapeHtml(txt.substring(0, text.start))) + (this.renderMainText(txt.substring(text.start, text.end))) + (escapeHtml(txt.substring(text.end))) + "</div>";
        } else {
          return this.renderMeat(parseOrgMode(block.text).children[0]);
        }
      },
      renderMainText: function(txt) {
        var org, pos, remaining, result;
        result = '';
        remaining = txt;
        pos = 0;
        while (remaining) {
          org = parseMeat(remaining, 0, '', true)[0];
          result += this.renderMeat(org);
          pos += org.offset + org.allText().length;
          remaining = txt.substring(pos);
        }
        return result;
      },
      renderMeat: function(org) {
        var result;
        result = '';
        while (org) {
          result += org instanceof SimpleMarkup ? this.renderSimple(org) : escapeHtml(org.allText());
          org = org.next;
        }
        return result;
      },
      renderSimple: function(org) {
        var c, guts, j, len, ref;
        guts = '';
        ref = org.children;
        for (j = 0, len = ref.length; j < len; j++) {
          c = ref[j];
          guts += this.renderMeat(c, true);
        }
        guts = "" + org.text[0] + guts + org.text[org.text.length - 1];
        switch (org.type === 'simple' && org.markupType) {
          case 'bold':
            return "<b>" + guts + "</b>";
          case 'italic':
            return "<i>" + guts + "</i>";
          case 'underline':
            return "<span style='text-decoration: underline'>" + guts + "</span>";
          case 'strikethrough':
            return "<span style='text-decoration: line-through'>" + guts + "</span>";
          case 'code':
            return "<code>" + guts + "</code>";
          case 'verbatim':
            return "<code>" + guts + "</code>";
          default:
            return escapeHtml(org.allText());
        }
      },
      renderSimpleChild: function(org) {
        if (!org.children) {
          return escapeHtml(org.text);
        } else {
          return this.renderSimple(org.children[0]);
        }
      }
    };
    toggleSlideMode = function(slideDom) {
      var block, blockHtml, opts, ref;
      if (opts = (ref = findEditor(slideDom)) != null ? ref.options : void 0) {
        block = opts.getBlock(opts.idForNode(slideDom[0]));
        opts.toggleSlide(block._id);
        blockHtml = opts.renderBlock(block)[0];
        preserveSelection(function() {
          var next, prev, results1;
          if (!opts.isToggled(block)) {
            next = block;
            while (isSidebar(next = opts.data.nextSibling(next))) {
              $(opts.nodeForId(next._id)).closest('.slideholder').closest('[data-view]').remove();
            }
          }
          prev = opts.editor.setHtml((block.type === 'headline' ? slideDom.closest('[data-view]') : slideDom.closest('[data-view="leisure-top-chunk"]'))[0], blockHtml, true);
          next = block;
          if (opts.isToggled(block)) {
            results1 = [];
            while (isSidebar(next = opts.data.nextSibling(next))) {
              $(prev).after(opts.renderBlock(next)[0]);
              results1.push(prev = prev.nextSibling);
            }
            return results1;
          }
        });
        initializePendingViews();
        return updateSelection();
      }
    };
    Handlebars.registerHelper('render', function(block) {
      return fancyMode.render(UI.context.opts, block, UI.context.prefix)[0];
    });
    Handlebars.registerHelper('renderHtml', function(html, options) {
      var controllerName, data, id, ids, opts, ref, ref1, ref10, ref11, ref2, ref3, ref4, ref5, ref6, ref7, ref8, ref9, tblocks, text, vars;
      opts = (ref = UI.context) != null ? ref.opts : void 0;
      ref3 = blockVars(opts != null ? opts.data : void 0, (ref1 = this.block) != null ? (ref2 = ref1.codeAttributes) != null ? ref2["var"] : void 0 : void 0), vars = ref3[0], ids = ref3[1];
      data = (ref4 = UI.context) != null ? (ref5 = ref4.opts) != null ? ref5.data : void 0 : void 0;
      controllerName = (ref6 = this.block) != null ? (ref7 = ref6.codeAttributes) != null ? ref7.controller : void 0 : void 0;
      id = (ref8 = (ref9 = UI.context) != null ? ref9.simpleViewId : void 0) != null ? ref8 : this.id;
      if (html) {
        vars = _.merge(vars, tblocks = touchedBlocks(html, options.data.opts.data));
        if (controllerName || (ids.length > 0 && (id = (ref10 = (ref11 = UI.context) != null ? ref11.simpleViewId : void 0) != null ? ref10 : this.id)) || !_.isEmpty(tblocks)) {
          pushPendingInitialzation((function(_this) {
            return function() {
              var blk, block, blocks, controller, env, j, len, len1, n, node, p, ref12, ref13, ref14, s, viewNode;
              viewNode = $("#" + id);
              if (ids.length && (node = opts.nodeForId(_this.block._id)) && (node[0] === viewNode[0] || node[0].compareDocumentPosition(viewNode[0]) & Element.DOCUMENT_POSITION_CONTAINS)) {
                blocks = (ref12 = node.attr('data-observe')) != null ? ref12 : '';
                for (j = 0, len = ids.length; j < len; j++) {
                  id = ids[j];
                  blocks += " " + id;
                }
                node.attr('data-observe', blocks);
              }
              if (!_.isEmpty(tblocks)) {
                s = new Set();
                ref14 = ((ref13 = viewNode.attr('data-observe')) != null ? ref13 : '').split(/\s+/);
                for (n = 0, len1 = ref14.length; n < len1; n++) {
                  blk = ref14[n];
                  s.add(blk);
                }
                for (blk in tblocks) {
                  s.add(blk);
                }
                viewNode.attr('data-observe', _.toArray(s).join(' ').trim());
              }
              if (controllerName) {
                if (!(controller = singleControllers[controllerName])) {
                  if (block = opts.data.getBlockNamed(controllerName)) {
                    controller = singleControllers[controllerName] = {};
                    env = blockEnvMaker(block)({
                      __proto__: defaultEnv
                    });
                    env["eval"] = function(text) {
                      return controllerEval.call(controller, text);
                    };
                    env.write = function(str) {
                      return console.log(str);
                    };
                    env.errorAt = function(offset, msg) {
                      return console.log(msg);
                    };
                    p = opts.data.getCode(block);
                    if (p instanceof Promise) {
                      p.then(function(func) {
                        return func.call(controller, null, viewNode);
                      });
                    } else {
                      p.call(controller, null, viewNode);
                    }
                  }
                }
                return controller != null ? typeof controller.initializeView === "function" ? controller.initializeView(viewNode[0], vars) : void 0 : void 0;
              }
            };
          })(this));
        }
        text = Handlebars.compile(html)(vars, {
          data: UI.context
        });
        if (!id && controllerName) {
          id = nextViewId();
          return "<span id='" + id + "'>" + text + "</span>";
        } else {
          return text;
        }
      } else {
        return '';
      }
    });
    initializePendingViews = function() {
      UI.initializePendingViews();
      return singleControllers = {};
    };
    Handlebars.registerHelper('renderPlain', function(data) {
      var block, edata, end, next, plainText, ref, ref1, text;
      text = '';
      edata = UI.context.opts.data;
      block = edata.getBlock(data.blockId);
      end = (ref = edata.nextRight(block)) != null ? ref._id : void 0;
      while (block && block._id !== end) {
        ref1 = plainMode.render(UI.context.opts, block, UI.context.prefix), plainText = ref1[0], next = ref1[1];
        text += plainText;
        block = edata.getBlock(next);
      }
      return text;
    });
    Handlebars.registerHelper('hiddenBeforeSource', function() {
      var source;
      source = this.codeItems.source;
      if (source.offset) {
        return "<span class='hidden'>" + (this.block.text.substring(0, source.offset)) + "</span>";
      } else {
        return '';
      }
    });
    Handlebars.registerHelper('hiddenAfterSource', function() {
      var end, source;
      source = this.codeItems.source;
      if ((end = source.end()) > this.block.text.length) {
        return "<span class='hidden'>" + (this.block.text.substring(source.end())) + "</span>";
      } else {
        return '';
      }
    });
    Handlebars.registerHelper('htmlDataUrl', function() {
      return "data:text/html;charset=utf-8," + (encodeURI(this.source));
    });
    Handlebars.registerHelper('sourceHeader', function() {
      var src;
      src = this.codeItems.source;
      return src.text.substring(0, src.contentPos);
    });
    Handlebars.registerHelper('sourceBoiler', function() {
      var src;
      src = this.codeItems.source;
      return src.text.substring(0, src.infoPos);
    });
    Handlebars.registerHelper('sourceInfo', function() {
      var src;
      src = this.codeItems.source;
      return src.text.substring(src.infoPos, src.contentPos);
    });
    Handlebars.registerHelper('renderSource', function() {
      var error, ignore, msg, pos, ref, ref1, source;
      ref = this.codeItems, error = ref.error, source = ref.source;
      if (error) {
        ref1 = error.info.match(/([^,]*), *(.*)/), ignore = ref1[0], pos = ref1[1], msg = ref1[2];
        pos = Number(pos) - 1;
        return prismHighlight(this.language, source.content.substring(0, pos)) + ("<span class='errorMark' contenteditable='false' data-noncontent>✖</span><span class='errorMessage' contenteditable='false' data-noncontent title='" + (escapeHtml(unescapeString(msg).replace(/\n/g, '<br>'))) + "'>✖</span><span class='errorSource'>") + prismHighlight(this.language, source.content.substring(pos)) + "</span>";
      } else {
        return prismHighlight(this.language, this.source);
      }
    });
    Handlebars.registerHelper('sourceFooter', function() {
      var src;
      src = this.codeItems.source;
      return src.text.substring(src.contentPos + src.content.length);
    });
    Handlebars.registerHelper('resultsHeader', function() {
      var res;
      res = this.codeItems.results;
      return res.text.substring(0, res.contentPos);
    });
    Handlebars.registerHelper('resultsContents', function() {
      var res;
      res = this.codeItems.results;
      if (this.hideResults) {
        return "<span class='hidden'>" + (escapeHtml(res.text)) + "</span>";
      } else {
        return resultsArea(UI.context.options, res.text.substring(res.contentPos));
      }
    });
    Handlebars.registerHelper('isExpected', function(options) {
      return !!options.data.opts.parsedCodeBlock(options.data.block).resultsAreExpected();
    });
    Handlebars.registerHelper('expectedResult', function(options) {
      var ref, ref1;
      return escapeHtml((ref = (ref1 = options.data.block.codeTestExpected) != null ? ref1.trim().replace(/^: /mg, '') : void 0) != null ? ref : '');
    });
    Handlebars.registerHelper('actualResult', function(options) {
      var ref, ref1;
      return escapeHtml((ref = (ref1 = options.data.block.codeTestActual) != null ? ref1.trim().replace(/^: /mg, '') : void 0) != null ? ref : '');
    });
    slideNode = function(node) {
      return $(node).closest('slideHolder').closest('[data-view]');
    };
    isHiddenSlide = function(block) {
      return block.type === 'headline' && blockIsHidden(block);
    };
    closeList = function(level, lastItem, stack) {
      var closeCount, prevLast;
      closeCount = 0;
      prevLast = lastItem;
      while (lastItem && lastItem.level > level) {
        delete lastItem.middleItem;
        lastItem.lastItem = true;
        lastItem = stack.pop();
        closeCount++;
      }
      prevLast.closeCount = closeCount;
      return lastItem;
    };
    classifyListItems = function(org) {
      var lastItem, stack;
      if (!(org.firstItem || org.middleItem || org.lastItem)) {
        stack = [];
        org.firstItem = true;
        lastItem = org;
        while (org = org.next) {
          if (org instanceof ListItem) {
            if (lastItem.level > org.level) {
              lastItem = closeList(org.level, lastItem, stack);
            }
            if (lastItem.level < org.level) {
              org.firstItem = true;
              stack.push(lastItem);
            } else {
              org.middleItem = true;
            }
            lastItem = org;
          }
        }
        return closeList(-1, lastItem, stack);
      }
    };
    fancyReplacements = {
      '<': '&lt;',
      '>': '&gt;',
      '&': '&amp;',
      '"': '&quot;',
      "'": '&#39;',
      " ": ' '
    };
    fancyHtml = function(str) {
      if (typeof str === 'string') {
        return str.replace(/[<>&\'\"]| +/g, function(c) {
          var i, j, ref, s;
          if (c === ' ') {
            return c;
          } else if (c[0] === ' ') {
            s = '';
            for (i = j = 1, ref = c.length; 1 <= ref ? j < ref : j > ref; i = 1 <= ref ? ++j : --j) {
              s += '&nbsp;';
            }
            s += ' ';
            return s;
          } else {
            return fancyReplacements[c];
          }
        });
      } else {
        return str;
      }
    };
    fancyMode = {
      name: 'fancy',
      keyPress: function(opts, parent, e) {
        var block, pos, sel;
        sel = getSelection();
        if (sel.type === 'Caret') {
          pos = opts.editor.getSelectedDocRange();
          sel = opts.editor.getSelectedBlockRange();
          block = opts.getBlock(sel.block);
          if (!opts.isToggled(block) && block.type !== 'code' && sel.offset === 0 && block.text[0] === '\n' && block.text[1] !== '\n') {
            e.preventDefault();
            opts.editor.replace(e, sel, (getEventChar(e)) + '\n', false);
            pos.type = 'Caret';
            pos.length = 0;
            pos.start++;
            opts.editor.selectDocRange(pos);
            return;
          }
        }
        return parent(e);
      },
      enter: function(opts, parent, e) {
        var block, endBlock, endSel, pt, sel, startBlock, t;
        block = opts.getBlock(opts.idForNode(getSelection().getRangeAt(0).startContainer));
        console.log("enter in block ", block._id);
        if (opts.isToggled(block) || block.type === 'code') {
          return parent(e);
        } else {
          sel = opts.editor.getSelectedBlockRange();
          startBlock = opts.data.getBlock(sel.block);
          endSel = opts.data.blockOffsetForDocOffset(opts.data.offsetForBlock(startBlock) + sel.offset + sel.length);
          endBlock = opts.data.getBlock(endSel.block);
          t = startBlock.text;
          if (!sel.offset && startBlock.prev) {
            pt = opts.data.getBlock(startBlock.prev).text;
            t = pt + t;
            sel.offset += pt.length;
          }
          if ((t.substring(0, sel.offset).match(/\n*$/)[0].length + endBlock.text.substring(endSel.offset).match(/^\n*/)[0].length) % 2) {
            return parent(e);
          }
          e.preventDefault();
          return opts.editor.replace(e, sel, '\n\n', false);
        }
      },
      handleDelete: function(opts, parent, e, sel, forward) {
        var block, blockOff, del, end, nt, ntNls, pos, prevBlock, pt, ptNls, r, start;
        r = sel.getRangeAt(0);
        start = opts.editor.docOffset(r.startContainer, r.startOffset);
        blockOff = opts.data.blockOffsetForDocOffset(start);
        block = opts.getBlock(blockOff.block);
        if (((block != null ? block.type : void 0) === 'code') || (forward && start === opts.getLength()) || (!forward && start === 0)) {
          return parent(e, sel, forward);
        }
        if (!forward) {
          --blockOff.offset;
          --start;
        }
        pos = start;
        if (blockOff.offset <= 0) {
          prevBlock = opts.getBlock(block.prev);
          blockOff.block = prevBlock;
          pt = prevBlock.text;
          blockOff.offset += pt.length;
          pt += block.text;
        } else {
          pt = block.text;
        }
        del = pt.substring(blockOff.offset, blockOff.offset + 1);
        nt = pt.substring(blockOff.offset + 1);
        pt = pt.substring(0, blockOff.offset);
        ptNls = pt.match(/\n*$/)[0].length;
        ntNls = nt.match(/^\n*/)[0].length;
        end = start + 1;
        if (ptNls > 0 && ntNls > 0) {
          if ((ptNls + ntNls) % 2) {
            start--;
          }
        } else if (del === '\n') {
          if (ntNls % 2) {
            end++;
          } else if (ptNls % 2) {
            start--;
            pos--;
          }
        }
        opts.replaceText({
          start: start,
          end: end,
          text: '',
          source: 'edit'
        });
        opts.editor.domCursorForDocOffset(pos).moveCaret();
        if (pos < opts.getLength() && pos !== opts.editor.docOffset(opts.editor.moveForward())) {
          return opts.editor.moveBackward();
        }
      },
      renderBlocks: function(opt, html) {
        var header;
        header = hasView('header') ? opt.withNewContext((function(_this) {
          return function() {
            return _this.renderView('header', null, null, {})[0];
          };
        })(this)) : "<div id='dummy_headline'></div>";
        return "" + header + html;
      },
      handleChanges: function(opts, changes) {
        var block, j, len, newNode, old, ref, results1, sibling, siblingNode;
        ref = changes.newBlocks;
        results1 = [];
        for (j = 0, len = ref.length; j < len; j++) {
          block = ref[j];
          if (changes.sets[block._id] && (old = opts.getBlock(block._id)) && isHiddenSlide(block) !== isHiddenSlide(old)) {
            if (isHiddenSlide(block)) {
              results1.push(slideNode(opts.nodeForId(block._id)).remove());
            } else {
              siblingNode = null;
              newNode = this.render(opts, block, opts.prefix)[0];
              sibling = block;
              while (!siblingNode && (sibling = opts.data.previousSibling(sibling, changes))) {
                if ((siblingNode = opts.nodeForId(sibling._id)).length === 0) {
                  siblingNode = null;
                }
              }
              if (siblingNode) {
                slideNode(siblingNode).after(newNode);
              } else {
                sibling = block;
                while (!siblingNode && (sibling = opts.data.nextSibling(sibling, changes))) {
                  if ((siblingNode = opts.nodeForId(sibling._id)).length === 0) {
                    siblingNode = null;
                  }
                }
                if (siblingNode) {
                  slideNode(siblingNode).before(newNode);
                } else {
                  $(opts.editor.node).prepend(newNode);
                }
              }
              results1.push(initializePendingViews());
            }
          } else {
            results1.push(void 0);
          }
        }
        return results1;
      },
      renderChanged: function(opts, blocks, prefix, replace) {
        var block, j, len, ref, rendered, results1, slide;
        rendered = {};
        results1 = [];
        for (j = 0, len = blocks.length; j < len; j++) {
          block = blocks[j];
          if (!opts.isToggled(block)) {
            results1.push(this.render(opts, block, prefix, replace));
          } else if (opts.isToggled(block) && !rendered[(ref = (slide = opts.slideFor(block))) != null ? ref._id : void 0]) {
            rendered[slide._id] = true;
            results1.push(this.render(opts, slide, prefix, replace));
          } else {
            results1.push(void 0);
          }
        }
        return results1;
      },
      render: function(opts, block, prefix, replace) {
        var ref;
        if (opts.shouldHide(block) || block.local) {
          return ['', (ref = opts.data.nextRight(block)) != null ? ref._id : void 0];
        } else {
          opts.trigger('render', block);
          return opts.withNewContext((function(_this) {
            return function() {
              UI.context.currentView = opts.nodeForId(block._id);
              UI.context.block = block;
              addPendingTooltip(opts, block._id);
              if (block.type === 'headline') {
                return _this.renderHeadline(opts, block, prefix, replace);
              } else if (!block.prev) {
                return _this.renderFirstBlocks(opts, block, prefix, replace);
              } else {
                return _this.renderNontop(opts, block, prefix, replace);
              }
            };
          })(this));
        }
      },
      renderNontop: function(opts, block, prefix, replace) {
        if (block.type === 'chunk') {
          return this.renderChunk(opts, block, prefix, replace);
        } else if (block.type === 'code') {
          return this.renderCode(opts, block, prefix, replace);
        } else {
          return plainMode.render(opts, block, prefix, replace);
        }
      },
      renderView: function(type, ctx, next, data, targets) {
        return [renderView(type, ctx, data, targets), next];
      },
      renderHeadline: function(opts, block, prefix, replace) {
        var id, m, next, nextText, parent, ref, ref1, ref2, ref3, ref4, sblock, sidebars, targets, text, viewName;
        next = (ref = opts.data.nextRight(block)) != null ? ref._id : void 0;
        viewName = block.type === 'headline' && block.level === 1 ? opts.isToggled(block) ? (UI.context.viewAttrs = _.merge({
          "class": 'plain'
        }, (ref1 = UI.context.viewAttrs) != null ? ref1 : {}), 'leisure-headline-plain') : 'leisure-top-headline' : 'leisure-headline';
        if (hasView(viewName)) {
          m = block.text.match(headlineRE);
          UI.context.currentView = targets = replacementTargets(block, prefix, replace);
          if (!opts.isToggled(block)) {
            if (block.level === 1 && isSidebar(block)) {
              parent = block;
              while (parent && isSidebar(parent)) {
                parent = opts.data.previousSibling(parent);
              }
              if (!parent || !opts.isToggled(parent)) {
                viewName = 'leisure-sidebar';
              }
            } else if (sidebars = this.getSidebars(opts, block)) {
              next = (ref2 = opts.data.nextRight(_.last(sidebars))) != null ? ref2._id : void 0;
              sidebars = (function() {
                var j, len, results1;
                results1 = [];
                for (j = 0, len = sidebars.length; j < len; j++) {
                  sblock = sidebars[j];
                  results1.push(this.render(opts, sblock, prefix)[0]);
                }
                return results1;
              }).call(this);
              viewName += '-with-sidebar';
            }
          }
          return this.renderView(viewName, null, next, {
            firstText: isFirstText(opts.data, block),
            id: prefix + block._id,
            blockId: block._id,
            EOL: '\n',
            style: (((ref3 = block.properties) != null ? ref3.style : void 0) ? "style='" + block.properties.style + "'" : ''),
            topLevel: block.level === 1,
            level: block.level,
            stars: m[HL_LEVEL],
            maintext: this.renderOrg(opts, cleanOrg(block.text.substring(m[HL_LEVEL].length))) + optWrench(block),
            children: opts.data.children(block),
            sidebars: sidebars
          }, targets);
        } else {
          text = "<span id='" + prefix + block._id + "' data-block='" + block.type + "'>";
          text += fancyHtml(block.text);
          id = block.next;
          while (id && id !== next) {
            ref4 = this.render(opts, opts.data.getBlock(id), prefix), nextText = ref4[0], id = ref4[1];
            text += nextText;
          }
          text += "</span>";
          maybeReplaceHtml(block, prefix, text, replace);
          return [text, next];
        }
      },
      getSidebars: function(opts, block) {
        var sidebars;
        if (block && (block.level === 1 || !block.prev) && !isSidebar(block)) {
          sidebars = [];
          while (isSidebar(block = opts.data.nextSibling(block))) {
            if (!opts.shouldHide(block)) {
              sidebars.push(block);
            }
          }
          if (sidebars.length) {
            return sidebars;
          }
        }
      },
      renderFirstBlocks: function(opts, block, prefix, replace) {
        var cur, next, plain, ref, ref1, targets, text, txt;
        if (hasView('leisure-top-chunk')) {
          if (plain = opts.isToggled(block)) {
            UI.context.viewAttrs = _.merge({
              "class": 'plain'
            }, (ref = UI.context.viewAttrs) != null ? ref : {});
          }
          text = '';
          cur = block;
          UI.context.currentView = targets = replacementTargets(block, prefix, replace);
          while (!(cur.type === 'headline' && cur.level === 1)) {
            ref1 = plain ? plainMode.render(opts, cur, prefix) : this.renderNontop(opts, cur, prefix), txt = ref1[0], next = ref1[1];
            text += txt;
            if (!next) {
              break;
            }
            cur = opts.getBlock(next);
          }
          return this.renderView('leisure-top-chunk', null, next, {
            id: prefix + block._id,
            text: text,
            topLevel: !block.prev,
            EOL: '\n'
          }, targets);
        } else {
          return this.renderNontop(opts, block, prefix);
        }
      },
      renderChunk: function(opts, block, prefix, replace) {
        var targets, viewType;
        viewType = 'leisure-chunk';
        UI.context.currentView = targets = replacementTargets(block, prefix, replace);
        if (hasView(viewType)) {
          return this.renderView(viewType, null, block.next, {
            id: prefix + block._id,
            firstText: isFirstText(opts.data, block),
            text: this.renderOrgChunk(opts, blockOrg(opts.data, block)),
            topLevel: !block.prev,
            EOL: '\n'
          }, targets);
        } else {
          return this.renderOrgBlock(opts, block, prefix, replace);
        }
      },
      renderCode: function(opts, block, prefix, replace) {
        var error, hideResults, items, key, lang, m, name, nameBoiler, org, ref, ref1, ref2, ref3, results, source, sourceData, targets;
        key = "leisure-code";
        org = blockOrg(opts.data, block);
        hideResults = !showsResults(block);
        ref2 = items = getCodeItems((ref = (ref1 = org.children) != null ? ref1[0] : void 0) != null ? ref : org), name = ref2.name, source = ref2.source, error = ref2.error, results = ref2.results;
        lang = results && results.text.length > results.contentPos && !showsCode(block) ? 'results-only' : items.source instanceof HTML ? 'inline-html' : block.language;
        if (hasView(key, lang)) {
          nameBoiler = name && (m = name.text.match(keywordRE)) ? m[KW_BOILERPLATE] : void 0;
          UI.context.currentView = targets = replacementTargets(block, prefix, replace);
          sourceData = {
            id: prefix + block._id,
            codeItems: items,
            language: block.language,
            hideResults: hideResults,
            block: block,
            header: block.text.substring(0, block.codePrelen),
            source: blockSource(block),
            footer: block.text.substring(block.text.length - block.codePostlen, source.end()),
            nameBoiler: nameBoiler != null ? nameBoiler : '',
            nameText: name ? name.text.substring(nameBoiler.length, name.text.length - 1) : '',
            name: name ? name.text.substring(name.info) : '',
            afterName: name ? this.renderOrg(opts, cleanOrg(block.text.substring(name.end(), source.offset)), true) : '',
            inter: this.interstitialCode(block, source, error, results),
            results: !results ? '' : hideResults ? "<span class='hidden'>" + (escapeHtml(results.text)) + "</span>" : resultsArea(opts, results.text, block),
            beforeResults: block.text.substring(0, (ref3 = results != null ? results.offset : void 0) != null ? ref3 : source.end())
          };
          sourceData.text = this.renderCodeOrg(opts, sourceData);
          return this.renderView(key, lang, block.next, sourceData, targets);
        } else {
          return plainMode.render(opts, block, prefix, replace);
        }
      },
      interstitialCode: function(block, source, error, results) {
        var ref, ref1;
        if (error) {
          return escapeHtml(block.text.substring(source.end(), error.offset)) + ("<span class='hidden'>" + (escapeHtml(error.text)) + "</span>") + escapeHtml(block.text.substring(error.end(), (ref = results != null ? results.offset : void 0) != null ? ref : block.text.length));
        } else {
          return escapeHtml(block.text.substring(source.end(), (ref1 = results != null ? results.offset : void 0) != null ? ref1 : block.text.length));
        }
      },
      renderOrgBlock: function(opts, block, prefix, replace) {
        var text;
        text = "<span id='" + block._id + "'>" + (this.renderOrg(opts, blockOrg(opts.data, block), true)) + "</span>";
        maybeReplaceHtml(block, prefix, replace);
        return [text, block.next];
      },
      renderCodeOrg: function(opts, context) {
        var block, error, name, pos, ref, ref1, ref2, ref3, ref4, results, source, text;
        block = context.block;
        ref = context.codeItems, name = ref.name, source = ref.source, error = ref.error, results = ref.results;
        text = '';
        pos = 0;
        ref1 = this.renderCodeSegment(opts, 'name', pos, text, context), pos = ref1[0], text = ref1[1];
        ref2 = this.renderCodeSegment(opts, 'source', pos, text, context), pos = ref2[0], text = ref2[1];
        ref3 = this.renderCodeSegment(opts, 'error', pos, text, context), pos = ref3[0], text = ref3[1];
        ref4 = this.renderCodeSegment(opts, 'results', pos, text, context), pos = ref4[0], text = ref4[1];
        if (pos < block.text.length) {
          text += fancyHtml(block.text.substring(pos));
        }
        return text;
      },
      renderCodeSegment: function(opts, name, pos, text, context) {
        var block, key, org;
        if (org = context.codeItems[name]) {
          block = context.block;
          if (hasView(key = "leisure-code-" + name, block.language)) {
            if (org.offset > pos) {
              text += fancyHtml(block.text.substring(pos, org.offset));
            }
            text += (this.renderView(key, block.language, null, context))[0];
            return [org.end(), text];
          } else if (name === 'results') {
            return [org.end(), resultsArea(opts, org.allText(), block)];
          } else {
            return [pos, text];
          }
        } else {
          return [pos, text];
        }
      },
      renderOrgChunk: function(opts, org) {
        var m, t;
        t = this.renderOrg(opts, org, true);
        if (m = t.match(/\n$/)) {
          return "<span class='org-chunk'>" + (t.substring(0, t.length - 1)) + "</span><span class='hidden'>\n</span>";
        } else {
          return "<span class='org-chunk'>" + t + "</span>";
        }
      },
      renderExample: function(opts, org) {
        var end, key, start, text;
        start = org.text.substring(0, org.contentPos);
        text = org.exampleText();
        end = org.text.substring(org.contentPos + org.contentLength);
        if (hasView(key = "leisure-example")) {
          return (this.renderView(key, null, null, {
            start: start,
            text: text,
            end: end,
            org: org
          }))[0];
        } else {
          return "<span class='hidden'>" + (escapeHtml(start)) + "</span><span class='example'>" + (fancyHtml(text)) + "</span><span class='hidden'>" + (escapeHtml(end)) + "</span>";
        }
      },
      renderOrg: function(opts, org, start, noName) {
        var boiler, child, i, name, nameText, named, ref, text;
        if (!noName && (ref = namedNode(org), name = ref[0], named = ref[1], ref) && named) {
          if (named !== org) {
            return '';
          }
          org = named;
          boiler = name.text.substring(0, name.text.length - name.info.length);
          nameText = "<div><span class='hidden'>" + (escapeHtml(boiler)) + "</span><span class='org-name'>" + (escapeHtml(name.info)) + "</span></div>";
          while ((name = name.next) !== org) {
            nameText += this.renderOrg(opts, name, start, true);
          }
        } else {
          nameText = '';
        }
        text = org instanceof SimpleMarkup ? this.renderSimple(opts, org) : org instanceof Link ? this.renderLink(opts, org) : org instanceof Fragment ? ((function() {
          var j, len, ref1, results1;
          ref1 = mergeMeat(org).children;
          results1 = [];
          for (i = j = 0, len = ref1.length; j < len; i = ++j) {
            child = ref1[i];
            results1.push(this.renderOrg(opts, child));
          }
          return results1;
        }).call(this)).join('') : org instanceof ListItem ? this.renderList(opts, org) : org instanceof Drawer ? this.renderDrawer(opts, org) : org instanceof Example ? this.renderExample(opts, org) : org instanceof Keyword && org.name.toLowerCase() === 'title' ? this.renderTitle(opts, org) : insertBreaks(fancyHtml(org.allText()));
        text = nameText + text;
        if (start) {
          return prefixBreak(text);
        } else {
          return text;
        }
      },
      renderHtml: function(opts, org) {
        return "<span class='hidden'>" + (escapeHtml(org.leading)) + "</span>" + ($(org.content)[0].outerHTML) + "<span class='hidden'>" + (escapeHtml(org.trailing)) + "</span>";
      },
      renderList: function(opts, org) {
        var child, i, j, ref, text;
        classifyListItems(org);
        text = org.firstItem ? '<ul>' : '';
        text += "<li><span class='hidden'>" + (escapeHtml(org.text.substring(0, org.contentOffset))) + "</span>" + (((function() {
          var j, len, ref, results1;
          ref = org.children;
          results1 = [];
          for (j = 0, len = ref.length; j < len; j++) {
            child = ref[j];
            results1.push(this.renderOrg(opts, child));
          }
          return results1;
        }).call(this)).join(''));
        for (i = j = 0, ref = org.closeCount; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
          text += '</ul>';
        }
        return text;
      },
      renderTitle: function(opts, org) {
        return "<span class='hidden'>" + (escapeHtml(org.text)) + "</span>";
      },
      renderLink: function(opts, org) {
        var attrs, block, c, data, desc, error, guts, ignore, j, leisureMatch, len, obj, objectName, ref, src, title, type, typeName, viewName;
        if (leisureMatch = org.isLeisure()) {
          ignore = leisureMatch[0], objectName = leisureMatch[1], viewName = leisureMatch[2], typeName = leisureMatch[3];
          data = UI.context.opts.data;
          error = !(obj = data.getBlockNamed(objectName)) ? "No object named " + objectName : !(obj = data.getYaml(block = data.getBlockNamed(objectName))) ? "Object " + objectName + " isn't yaml" : !(type = typeName || (obj != null ? obj.type : void 0)) ? "No type field in object " + objectName : !hasView(type, viewName) ? "No view '" + (viewKey(type, viewName)) + "'" : void 0;
          if (error) {
            if (objectName) {
              attrs = " data-view-block-name='" + objectName + "'" + (viewName ? ' data-view-name=\'' + viewName + '\'' : '');
            } else {
              attrs = '';
            }
            return "<span class='error' title='" + (escapeAttr(error)) + "'" + attrs + "><b data-noncontent >✖</b>" + (fancyHtml(org.allText())) + "<span>";
          } else {
            return "<span class='hidden link'>" + (escapeHtml(org.allText())) + "</span><span data-noncontent contenteditable='false'>" + (renderView(type, viewName, obj, null, block, objectName)) + "</span>";
          }
        } else if (org.isImage()) {
          title = ((desc = org.descriptionText()) ? " title='" + (fancyHtml(desc)) + "'" : "");
          src = fancyHtml(org.path);
          if (org.path.indexOf('file:') === 0) {
            src = prevImageSrc(src);
          }
          return (opts.renderImage(src, title)) + "<span class='hidden link'>" + (escapeHtml(org.allText())) + "</span>";
        } else {
          guts = '';
          ref = org.children;
          for (j = 0, len = ref.length; j < len; j++) {
            c = ref[j];
            guts += this.renderOrg(opts, c);
          }
          if (!guts) {
            return "<span class='hidden link'>[[</span><a onclick='Leisure.followLink(event)' href='" + org.path + "'>" + org.path + "</a><span class='hidden'>]]</span>";
          } else {
            return "<span class='hidden link'>[[" + org.path + "][</span><a onclick='Leisure.followLink(event)' href='" + org.path + "'>" + guts + "</a><span class='hidden'>]]</span>";
          }
        }
      },
      renderSimple: function(opts, org) {
        var c, guts, j, len, ref, text;
        guts = '';
        ref = org.children;
        for (j = 0, len = ref.length; j < len; j++) {
          c = ref[j];
          guts += this.renderOrg(opts, c);
        }
        text = (function() {
          switch (org.markupType) {
            case 'bold':
              return "<b>" + guts + "</b>";
            case 'italic':
              return "<i>" + guts + "</i>";
            case 'underline':
              return "<span style='text-decoration: underline'>" + guts + "</span>";
            case 'strikethrough':
              return "<span style='text-decoration: line-through'>" + guts + "</span>";
            case 'code':
              return "<code>" + guts + "</code>";
            case 'verbatim':
              return "<code>" + guts + "</code>";
            default:
              return guts;
          }
        })();
        return "<span class='hidden'>" + org.text[0] + "</span>" + text + "<span class='hidden'>" + (goodText(org.text[0])) + "</span>";
      },
      renderDrawer: function(opts, org) {
        if (org.name.toLowerCase() === 'properties') {
          return "<span class='hidden'>" + (escapeHtml(org.allText())) + "</span>";
        } else {
          return "<span class='org-properties'>" + (fancyHtml(org.allText())) + "</span>";
        }
      },
      showingSlides: function(opt) {
        return opt.editor.node.is('.slides');
      },
      setSlideMode: function(opt, flag) {
        var slides;
        if (flag) {
          opt.editor.node.addClass('slides');
          slides = this.getSlides(opt);
          slides.removeClass('firstSlide').removeClass('lastSlide');
          slides.first().addClass('firstSlide');
          slides.last().addClass('lastSlide');
          return this.showSlide(opt, slides.first());
        } else {
          opt.editor.node.removeClass('slides');
          $(opt.editor.node).find('.currentSlide').removeClass('currentSlide');
          return opt.currentSlide = null;
        }
      },
      getSlides: function(opt) {
        return $(opt.editor.node).find('[data-view=leisure-top-headline], [data-view=leisure-top-chunk]');
      },
      firstSlide: function(opt) {
        return this.getSlides(opt).first();
      },
      lastSlide: function(opt) {
        return this.getSlides(opt).last();
      },
      showSlide: function(opt, slide, slides) {
        var top;
        slides = slides != null ? slides : this.getSlides(opt);
        top = $(opt.editor.node);
        top.removeClass('firstSlide').removeClass('lastSlide');
        $(opt.editor.node).find('.currentSlide').removeClass('currentSlide');
        $(slide).addClass('currentSlide');
        if ($(slide)[0] === slides[0]) {
          top.addClass('firstSlide');
        }
        if ($(slide)[0] === _.last(slides)) {
          top.addClass('lastSlide');
        }
        return opt.currentSlide = opt.idForNode($(slide).find('[data-block]:first'));
      },
      showNextSlide: function(opt) {
        var next;
        if (this.showingSlides(opt)) {
          next = $('.currentSlide').next('[data-view=leisure-top-headline], [data-view=leisure-top-chunk]');
          if (next.length) {
            this.showSlide(opt, next);
            return true;
          }
        }
        return false;
      },
      showPrevSlide: function(opt) {
        var prev;
        if (this.showingSlides(opt)) {
          prev = $('.currentSlide').prev('[data-view=leisure-top-headline], [data-view=leisure-top-chunk]');
          if (prev.length) {
            this.showSlide(opt, prev);
            return true;
          }
        }
        return false;
      }
    };
    isFirstText = function(source, block) {
      var original, parent;
      if ((block.type === 'chunk' || (block.type === 'headline' && block.level > 1)) && (parent = source.parent(block)) && parent.level === 1) {
        original = block;
        while ((block = source.previousSibling(block)) && !maybeFirst(block)) {}
        return !block && findFirstLetter(original.text);
      }
    };
    maybeFirst = function(block) {
      var ref;
      return (((ref = block.type) === 'chunk' || ref === 'headline') && findFirstLetter(block.text)) || (block.type === 'code' && block.language !== 'html');
    };
    findFirstLetter = function(text) {
      var ref;
      return (ref = text.match(/[a-zA-Z0-9]/)) != null ? ref[0][0].toUpperCase() : void 0;
    };
    pendingTooltips = null;
    addPendingTooltip = function(opts, blockId) {
      if (!pendingTooltips) {
        pendingTooltips = new Map();
        pushPendingInitialzation(function() {
          var nodes;
          nodes = new Set();
          pendingTooltips.forEach(function(ids, opts) {
            var id, j, len, node, results1;
            results1 = [];
            for (j = 0, len = ids.length; j < len; j++) {
              id = ids[j];
              results1.push((function() {
                var len1, n, ref, results2;
                ref = opts.nodeForId(id).find('[title]');
                results2 = [];
                for (n = 0, len1 = ref.length; n < len1; n++) {
                  node = ref[n];
                  results2.push(nodes.add(node));
                }
                return results2;
              })());
            }
            return results1;
          });
          nodes.forEach(function(node) {
            node.INIT_TOOLTIP = true;
            return $(node).tooltip({
              content: $(node).attr('title')
            });
          });
          return pendingTooltips = null;
        });
      }
      if (!pendingTooltips.get(opts)) {
        pendingTooltips.set(opts, []);
      }
      return pendingTooltips.get(opts).push(blockId);
    };
    isMeat = function(org) {
      return org && (org instanceof SimpleMarkup || org.constructor === Meat);
    };
    namedNode = function(org) {
      var end, name;
      end = org;
      if (isMeat(org) || org instanceof Example || org instanceof Drawer) {
        while (isMeat(org = org.prev)) {}
      }
      if (org instanceof Keyword && (org.name.match(/^name$/i)) && (name = org)) {
        if (name === end) {
          end = end.next;
        }
        while (isMeat(end) && (end = end.next)) {}
        if (end instanceof Example || end instanceof Drawer) {
          return [name, end];
        }
      }
      return [];
    };
    isSidebar = function(block) {
      var ref;
      return (block != null ? (ref = block.properties) != null ? ref.note : void 0 : void 0) === 'sidebar';
    };
    optWrench = function(block) {
      var k, props, ref, v, wrench;
      if (block.properties && !_.isEmpty(block.properties)) {
        props = "<div><b>Properties</b></div>";
        ref = block.properties;
        for (k in ref) {
          v = ref[k];
          props += "<p>:" + k + ": " + v;
        }
        wrench = $("<i class='fa fa-wrench'></i>")[0];
        wrench.setAttribute('title', props);
        return wrench.outerHTML;
      } else {
        return '';
      }
    };
    insertBreaks = function(text) {
      return text.replace(/\n\n/g, function(match, offset, str) {
        if (str[offset + 2] === '\n') {
          return "\n<span class='hidden'>\n</span><span contenteditable='false'><div style='white-space: pre; height: 2em' data-noncontent></div></span><div style='height: 1em; white-spaceX: pre' data-noncontent>\n</div><span class='hidden'></span>";
        } else {
          return "\n<span class='hidden'>\n</span><span contenteditable='false'><div style='height: 2em; white-space: pre' data-noncontent></div></span>";
        }
      });
    };
    prefixBreak = function(text) {
      if (text[0] === '\n' && text[1] !== '\n') {
        return "\n<div style='height: 2em; white-space: pre' data-noncontent>\n</div>" + (text.substring(1));
      } else {
        return text;
      }
    };
    createValueSliders = function() {
      var j, len, num, ref, results1;
      ref = $(UI.context.currentView).find('.token.number');
      results1 = [];
      for (j = 0, len = ref.length; j < len; j++) {
        num = ref[j];
        results1.push($(num).on('click', function() {
          return showValueSlider(this);
        }));
      }
      return results1;
    };
    showValueSlider = function(number) {
      var blockOff, data, editor, widget;
      editor = findEditor(number);
      data = editor.options.data;
      widget = editor.node.find('[name=valueSlider]');
      blockOff = editor.blockOffset(number, 0);
      currentSlider = {
        editor: editor,
        data: data,
        widget: widget,
        sliding: true,
        number: Number(number.textContent)
      };
      widget.removeClass('hidden');
      widget.position({
        my: 'center top',
        at: 'center bottom',
        of: number
      });
      data.addMark('__slider__', data.docOffsetForBlockOffset(blockOff));
      return setSliderValue(Number(number.textContent));
    };
    setSliderValue = function(val) {
      var widget;
      widget = currentSlider.widget;
      if ((-50 <= val && val <= 50)) {
        widget.slider('option', 'min', Math.min(-100, -Math.abs(val * 2)));
        widget.slider('option', 'max', Math.max(100, Math.abs(val * 2)));
      } else if (val > 50) {
        widget.slider('option', 'min', 0);
        widget.slider('option', 'max', val * 2);
      } else {
        widget.slider('option', 'min', val * 2);
        widget.slider('option', 'max', 0);
      }
      return widget.slider('value', val);
    };
    setSliding = function(flag) {
      if (!flag && currentSlider) {
        setSliderValue(currentSlider.widget.slider('value'));
      }
      return setTimeout((function() {
        return currentSlider != null ? currentSlider.sliding = flag : void 0;
      }), 1);
    };
    slideValue = function() {
      var block, blockOff, cs, delta, m, newText, pos, start;
      if ((cs = currentSlider) && !cs.editor.options.awaitingGuard) {
        start = cs.data.getMarkLocation('__slider__');
        blockOff = cs.data.blockOffsetForDocOffset(start);
        block = cs.editor.options.getBlock(blockOff.block);
        m = numPat.exec(block.text.substring(blockOff.offset));
        delta = currentSlider.widget.slider('value') - cs.number;
        cs.number = currentSlider.widget.slider('value');
        newText = String(currentSlider.widget.slider('value'));
        if (delta !== 0) {
          if (block.local) {
            return cs.editor.options.replaceText({
              start: start,
              end: start + m[0].length,
              text: newText,
              source: 'edit'
            });
          } else {
            if (pos = getSliderPosition()) {
              pos.delta = delta;
              return sendSliderChange(pos);
            }
          }
        }
      }
    };
    sendSliderChange = function(pos) {
      var cs, delta, numberCount, numberOffset, offset, start;
      cs = currentSlider;
      if (cs.awaitingChange) {
        if (cs.nextChange) {
          pos.delta += cs.nextChange.delta;
        }
        return cs.nextChange = pos;
      } else {
        cs.awaitingChange = true;
        start = pos.start, offset = pos.offset, numberCount = pos.numberCount, numberOffset = pos.numberOffset, delta = pos.delta;
        return cs.editor.options.data.collaborativeCode.doSlideValue(cs.editor.options, start, offset, numberCount, numberOffset, delta).then(function() {
          cs.awaitingChange = false;
          if (pos = cs.nextChange) {
            cs.nextChange = null;
            return sendSliderChange(pos);
          }
        });
      }
    };
    doSlideValue = function(arg, opts, start, offset, numberCount, numberOffset, delta) {
      var block, cur, dist, j, len, m, newText, node, numCur, number, numbers, slaveId, sliderNode, targetDistance;
      slaveId = arg.slaveId;
      block = opts.data.blockOffsetForDocOffset(start).block;
      node = opts.nodeForId(block);
      block = opts.data.getBlock(block);
      cur = opts.editor.domCursor(node, 0).firstText();
      sliderNode = $(cur.mutable().forwardChars(offset, true).firstText().node).closest('.token.number');
      if (sliderNode.length) {
        numCur = opts.editor.domCursor(sliderNode[0], 0);
        offset = cur.getTextTo(numCur).length;
      } else {
        numbers = node.find('.token.number');
        if (!numbers.length) {
          return null;
        } else if (numbers.length === numberCount) {
          numCur = opts.editor.domCursor(numbers[numberOffset], 0);
          offset = cur.getTextTo(numCur).length;
        } else {
          offset = 0;
          targetDistance = Number.MAX_VALUE;
          for (j = 0, len = numbers.length; j < len; j++) {
            number = numbers[j];
            number = numbers[testPos];
            numCur = opts.editor.domCursor(number, 0);
            offset += cur.getTextTo(numCur).length;
            cur = numCur;
            dist = offset - offset;
            if (targetDistance > dist) {
              targetDistance = dist;
            } else if (offset > offset) {
              break;
            }
          }
        }
      }
      m = numPat.exec(block.text.substring(offset));
      newText = String(delta + Number(m[0]));
      start = offset + opts.data.offsetForBlock(block);
      return opts.replaceText({
        start: start,
        end: start + m[0].length,
        text: newText,
        source: 'code'
      });
    };
    getSliderPosition = function() {
      var block, cs, cursor, j, len, node, nth, number, numbers, offset, opts, ref, sliderNode, start;
      cs = currentSlider;
      start = cs.data.getMarkLocation('__slider__');
      opts = cs.editor.options;
      ref = cs.data.blockOffsetForDocOffset(start), block = ref.block, offset = ref.offset;
      node = opts.nodeForId(block);
      cursor = opts.domCursor(node[0], 0).mutable().forwardChars(offset, true).firstText();
      sliderNode = $(cursor.node).closest('.token.number');
      if (!sliderNode.length) {
        cursor.backwardChar();
        sliderNode = $(cursor.node).closest('.token.number');
        if (!sliderNode.length) {
          console.error("Could not find slider node for block: " + block + ", offset: " + (offset - 1) + ", '" + cs.data.blocks[block].text[offset] + "', node:", cursor.node);
          return;
        }
      }
      nth = 0;
      numbers = node.find('.token.number');
      for (j = 0, len = numbers.length; j < len; j++) {
        number = numbers[j];
        if (number === sliderNode[0]) {
          return {
            start: start,
            offset: offset,
            numberCount: numbers.length,
            numberOffset: nth
          };
        }
        nth++;
      }
    };
    mayHideValueSlider = function() {
      if (currentSlider && !(currentSlider != null ? currentSlider.sliding : void 0)) {
        currentSlider.data.removeMark('__slider__');
        currentSlider.widget.addClass('hidden');
        return currentSlider = null;
      }
    };
    showsCode = function(codeBlock) {
      var exports, ref, ref1;
      exports = (ref = codeBlock.codeAttributes) != null ? (ref1 = ref.exports) != null ? ref1.split(' ') : void 0 : void 0;
      return !exports || !(indexOf.call(exports, 'results') >= 0);
    };
    showsResults = function(codeBlock) {
      var exports, ref, ref1;
      exports = (ref = codeBlock.codeAttributes) != null ? (ref1 = ref.exports) != null ? ref1.split(' ') : void 0 : void 0;
      return !exports || !(indexOf.call(exports, 'code') >= 0);
    };
    _workSpan = null;
    workSpan = function() {
      return _workSpan || createWorkSpan();
    };
    createWorkSpan = function() {
      return _workSpan = $("<span></span>");
    };
    goodHtml = function(text) {
      var ref;
      return (ref = workSpan().html(text).html()) != null ? ref : '';
    };
    goodText = function(text) {
      var ref;
      return (ref = workSpan().text(text).html()) != null ? ref : '';
    };
    isViewResult = function(block) {
      var ref, ref1;
      return (ref = block.codeAttributes) != null ? (ref1 = ref.results) != null ? ref1.match(/\bview\b(?:\(([^\/]*(?:\/(.*))?)\))?/i) : void 0 : void 0;
    };
    resultsArea = function(opts, results, block) {
      var firstResult, ignore, m, obj, objectName, type, viewName;
      firstResult = results.indexOf('\n') + 1;
      if (m = isViewResult(block)) {
        obj = parseYaml(results.substring(firstResult).replace(/(^|\n): /gm, '$1'));
        ignore = m[0], type = m[1], viewName = m[2];
        type = type != null ? type : obj.type;
        objectName = blockCodeItems(opts, block).name;
        return "<span class='hidden'>" + (escapeHtml(results)) + "</span>" + (renderView(type, viewName, obj, null, null, null, null, 'data-noncontent'));
      } else if (false && isYamlResult(block)) {
        return "<span class='hidden'>" + (results.substring(0, firstResult)) + "</span><span class='yaml results-verbatim' data-noncontent>" + (results.substring(firstResult).replace(/^(: )(.*\n)/gm, function(m, g1, g2) {
          return goodHtml(g2);
        })) + "</span>";
      } else if (!firstResult || results[firstResult] === ':') {
        return "<span class='hidden'>" + (goodText(results)) + "</span><span class='results-verbatim' data-noncontent>" + (results.substring(firstResult).replace(/^(: )(.*\n)/gm, function(m, g1, g2) {
          return goodHtml(g2);
        })) + "</span>";
      } else {
        return "<span class='hidden'>" + (results.substring(0, firstResult)) + "</span>" + (fancyMode.renderOrg(opts, cleanOrg(results.substring(firstResult))));
      }
    };
    plainEditDiv = function(div, data) {
      $(div).addClass('plain');
      return new LeisureEditCore($(div), new OrgEditing(data));
    };
    fancyEditDiv = function(div, data) {
      var options;
      options = new OrgEditing(data).setMode(fancyMode);
      data.openRegistration();
      data.registerCollaborativeCode('doSlideValue', doSlideValue);
      data.registerCollaborativeCode('viewBoundSet', function(context, name, value) {
        return data.setData(name, value);
      });
      data.closeRegistration();
      return new LeisureEditCore($(div), options);
    };
    prismAliases = {
      html: 'handlebars',
      coffee: 'coffeescript',
      cs: 'coffeescript',
      js: 'javascript',
      lisp: 'scheme',
      leisure: 'leisure'
    };
    prismHighlight = function(lang, text) {
      var l;
      if (l = prismAliases[lang]) {
        lang = l;
      }
      if (Prism.languages[lang]) {
        return Prism.highlight(text, Prism.languages[lang], lang);
      } else {
        return "<span class='unknown-language'>" + (fancyHtml(text)) + "</span>";
      }
    };
    replacementTargets = function(block, prefix, replace) {
      var targets;
      if (replace && (targets = $("#" + prefix + block._id)) && targets.length) {
        return targets.closest('[data-view]');
      }
    };
    maybeReplaceHtml = function(block, prefix, html, replace) {
      var ref;
      if ((ref = replacementTargets(block, prefix, replace)) != null) {
        ref.replaceWith(html);
      }
      if (replace) {
        return initializePendingViews();
      }
    };
    cleanOrg = function(text) {
      return blockOrg(null, {
        text: text
      });
    };
    mergeMeat = function(fragment) {
      var c, i, j, len, newC, newChildren, prevMeat, ref;
      newChildren = [];
      prevMeat = null;
      ref = fragment.children;
      for (i = j = 0, len = ref.length; j < len; i = ++j) {
        c = ref[i];
        if (c.__proto__ === Meat.prototype) {
          if (!prevMeat) {
            prevMeat = new Meat(c.text, c.offset);
            newChildren.push(prevMeat);
          } else {
            prevMeat.text += c.text;
          }
        } else {
          if (prevMeat) {
            prevMeat = null;
          }
          newC = _.clone(c);
          newC.__proto__ = c.__proto__;
          newChildren.push(newC);
        }
      }
      return new Fragment(fragment.offset, newChildren).linkNodes();
    };
    Object.assign(Leisure, {
      plainMode: plainMode,
      fancyMode: fancyMode,
      toggleSlideMode: toggleSlideMode,
      blockVars: blockVars,
      createValueSliders: createValueSliders,
      slideValue: slideValue,
      mayHideValueSlider: mayHideValueSlider,
      setSliding: setSliding,
      cleanOrg: cleanOrg,
      showsCode: showsCode,
      showsResults: showsResults
    });
    return {
      plainMode: plainMode,
      fancyMode: fancyMode,
      plainEditDiv: plainEditDiv,
      fancyEditDiv: fancyEditDiv,
      doSlideValue: doSlideValue
    };
  });

}).call(this);

//# sourceMappingURL=modes.js.map
